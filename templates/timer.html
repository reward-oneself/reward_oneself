<!--è¯¥ä»£ç ç”±Traeç”Ÿæˆï¼Œå…¶å®æˆ‘ä¸€ç‚¹éƒ½ä¸ä¼šJavaScriptï¼ˆAIçœŸçš„å¤ªå¥½ç”¨äº†ä½ ä»¬çŸ¥é“å—ï¼‰-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <!-- æ·»åŠ ç§»åŠ¨ç«¯é€‚é…è§†å£è®¾ç½® -->
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="{{ url_for('static', filename='css.css') }}" rel="stylesheet">
    <title>è®¡æ—¶å™¨</title>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            justify-content: center;
            /* æ°´å¹³å±…ä¸­ */
            align-items: center;
            /* å‚ç›´å±…ä¸­ */
        }

        .timer-div {
            width: 80%;
            height: 50%;
            background: #3498db;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        @media (max-width: 768px) {
            footer{
                height: 10%;
                width: 100%;
                font-size: 10px;
            }
        }
    </style>

</head>

<body>
    <div class="timer-div">
        <h1>{{ name }}</h1>
        <b id="status">å·¥ä½œä¸­</b>
        <div id="time-display" style="font-size: 48px; margin: 20px 0;">00:00</div>
        <p class="audio-prompt" style="color: rgb(255, 255, 0); background-color: rgba(255, 0, 0, 0.5); padding: 10px 0;">ğŸ”ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®è§£é”æç¤ºéŸ³æ’­æ”¾</p>
        <form action="/point" method="post" id="timer-form" style="display: none;">
            <input name="csrf_token" type="hidden" class="csrf_token" value="{{ csrf_token() }}"></input>
            <input type="hidden" name="name" value="{{ name }}">
            <input type="hidden" name="point_change" value="{{ value }}">
            <input type="hidden" name="time" value="{{ time }}">
            <input type="hidden" name="repeat" value="{{ repeat }}">
            <input type="hidden" name="from" value="timer">
        </form>
    </div>
    <footer>
        <p>æœ¬é¡µé¢çš„è®¡æ—¶å™¨æç¤ºéŸ³æ˜¯ï¼šè‡ªåˆ¶æ‰‹æœºé“ƒå£° è®¸å¯:CC-BY ä½œè€…:scottchains æ¥æº:è€³è†ç½‘ https://www.ear0.com/sound/37361</p>
        <p>æœ¬é¡µé¢çš„å®ŒæˆéŸ³æ•ˆæ˜¯ï¼šå®ŒæˆéŸ³æ•ˆ è®¸å¯:CC-BY-NC ä½œè€…:nckn æ¥æº:è€³è†ç½‘ https://www.ear0.com/sound/12432</p>
    </footer>
    <!-- å¼•å…¥ NoSleep.js -->
    <script src="{{ url_for('static', filename='js/NoSleep.min.js') }}"></script>
    <script>
        // åˆå§‹åŒ– NoSleep
        var noSleep = new NoSleep();
        console.log('NoSleep å·²åˆå§‹åŒ–');

        
        // åˆå§‹åŒ–å‚æ•°
        const workTime = parseInt({{ time }}); 
        const restRatio = parseInt({{ rest_time_to_work_ratio }}); 
        const restTime = Math.round(workTime / restRatio); 
        const isRepeat = {{ repeat | lower }}; 

        let currentTime = workTime * 60; 
        let isWorking = true;
        let timerInterval;
        let heartbeatInterval; // å¿ƒè·³ä¿æ´»å®šæ—¶å™¨
        let audioContext; // æ–°å¢éŸ³é¢‘ä¸Šä¸‹æ–‡å˜é‡

        // æ–°å¢ï¼šç”¨æˆ·é¦–æ¬¡ç‚¹å‡»è§£é”è‡ªåŠ¨æ’­æ”¾å’Œé˜²æ­¢ä¼‘çœ 
        function unlockAudio() {
            // å¯ç”¨ NoSleep é˜²æ­¢è®¾å¤‡ä¼‘çœ 
            try{
            noSleep.enable();
            console.log('NoSleep å·²å¯ç”¨');
            } catch (error) {
                console.error('NoSleep å¯ç”¨å¤±è´¥ï¼š', error);
            }
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.resume().then(() => {
                console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²è§£é”');
                document.querySelector('.audio-prompt').style.display = 'none'; // éšè—æç¤º
            });
            document.body.removeEventListener('click', unlockAudio);
        }
        document.body.addEventListener('click', unlockAudio); // ç›‘å¬é¦–æ¬¡ç‚¹å‡»

        // å¿ƒè·³ä¿æ´»å‡½æ•°
        function sendHeartbeat() {
            // åˆ›å»ºä¸€ä¸ªéšè—çš„iframeæ¥å‘é€å¿ƒè·³è¯·æ±‚
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = '/heartbeat';
            document.body.appendChild(iframe);
            
            // ä¸€æ®µæ—¶é—´åç§»é™¤iframeä»¥é‡Šæ”¾èµ„æº
            setTimeout(() => {
                if (iframe.parentNode) {
                    iframe.parentNode.removeChild(iframe);
                }
            }, 5000); // 5ç§’åç§»é™¤
        }

        // å¯åŠ¨å¿ƒè·³ä¿æ´»æœºåˆ¶ï¼Œæ¯5åˆ†é’Ÿå‘é€ä¸€æ¬¡å¿ƒè·³
        function startHeartbeat() {
            // ç«‹å³å‘é€ä¸€æ¬¡å¿ƒè·³
            sendHeartbeat();
            // æ¯5åˆ†é’Ÿå‘é€ä¸€æ¬¡å¿ƒè·³
            heartbeatInterval = setInterval(sendHeartbeat, 5 * 60 * 1000);
        }

        // åœæ­¢å¿ƒè·³ä¿æ´»æœºåˆ¶
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            // ç¦ç”¨ NoSleep å…è®¸è®¾å¤‡ä¼‘çœ 
            noSleep.disable();
            console.log('NoSleep å·²ç¦ç”¨');
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼ˆä¿æŒä¸å˜ï¼‰
        function updateDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            document.getElementById('time-display').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // åˆ‡æ¢é˜¶æ®µ
        function switchPhase() {
            isWorking = !isWorking;
            currentTime = isWorking ? workTime * 60 : restTime * 60;
            document.getElementById('status').textContent = isWorking ? 'å·¥ä½œä¸­' : 'ä¼‘æ¯ä¸­';

            // ä¼‘æ¯é˜¶æ®µå¼€å§‹æ—¶æ’­æ”¾éŸ³é¢‘ï¼ˆä½¿ç”¨å·²è§£é”çš„ä¸Šä¸‹æ–‡ï¼‰
            if (!isWorking && restTime > 0) {
                const audio = new Audio("/timer_sound");
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤ä¸Šä¸‹æ–‡ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => audio.play());
                } else {
                    audio.play().catch(error => {
                        console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                    });
                }
            }
        }

        // å€’è®¡æ—¶ç»“æŸå¤„ç†
        function handleFinish() {
            clearInterval(timerInterval);
            if (isWorking) {
                // å·¥ä½œç»“æŸååˆ‡æ¢åˆ°ä¼‘æ¯
                if (restTime > 0) {
                    switchPhase();
                    timerInterval = setInterval(() => {
                        currentTime--;
                        updateDisplay();
                        if (currentTime <= 0) handleFinish();
                    }, 1000);
                } else {
                    // æ— ä¼‘æ¯æ—¶é—´ç›´æ¥æäº¤
                    stopHeartbeat(); // åœæ­¢å¿ƒè·³
                    document.getElementById('timer-form').submit();
                }
            } else {
                // ä¼‘æ¯ç»“æŸï¼Œæ’­æ”¾å®ŒæˆéŸ³æ•ˆ
                const finishAudio = new Audio("/finish_sound");
                finishAudio.play().then(() => {
                    // éŸ³æ•ˆæ’­æ”¾å®Œæˆåæäº¤è¡¨å•
                    stopHeartbeat(); // åœæ­¢å¿ƒè·³
                    document.getElementById('timer-form').submit();
                }).catch(error => {
                    console.error('å®ŒæˆéŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
                    // å³ä½¿æ’­æ”¾å¤±è´¥ï¼Œä»ç„¶æäº¤è¡¨å•
                    stopHeartbeat(); // åœæ­¢å¿ƒè·³
                    document.getElementById('timer-form').submit();
                });
            }
        }

        // å¯åŠ¨è®¡æ—¶å™¨
        updateDisplay();
        startHeartbeat(); // å¯åŠ¨å¿ƒè·³ä¿æ´»
        timerInterval = setInterval(() => {
            currentTime--;
            updateDisplay();
            if (currentTime <= 0) handleFinish();
        }, 1000);
    </script>
</body>

</html>