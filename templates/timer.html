<!--该代码由Trae生成，其实我一点都不会JavaScript（AI真的太好用了你们知道吗）-->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <!-- 添加移动端适配视口设置 -->
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="{{ url_for('static', filename='css.css') }}" rel="stylesheet">
    <title>计时器</title>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            justify-content: center;
            /* 水平居中 */
            align-items: center;
            /* 垂直居中 */
        }

        .timer-div {
            width: 80%;
            height: 50%;
            background: #3498db;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        @media (max-width: 768px) {
            footer{
                height: 10%;
                width: 100%;
                font-size: 10px;
            }
        }
    </style>

</head>

<body>
    <div class="timer-div">
        <h1>{{ name }}</h1>
        <b id="status">工作中</b>
        <div id="time-display" style="font-size: 48px; margin: 20px 0;">00:00</div>
        <p class="audio-prompt" style="color: rgb(255, 255, 0); background-color: rgba(255, 0, 0, 0.5); padding: 10px 0;">🔐点击页面任意位置解锁提示音播放</p>
        <form action="/point" method="post" id="timer-form" style="display: none;">
            <input name="csrf_token" type="hidden" class="csrf_token" value="{{ csrf_token() }}"></input>
            <input type="hidden" name="name" value="{{ name }}">
            <input type="hidden" name="point_change" value="{{ value }}">
            <input type="hidden" name="time" value="{{ time }}">
            <input type="hidden" name="repeat" value="{{ repeat }}">
            <input type="hidden" name="from" value="timer">
        </form>
    </div>
    <footer>
        <p>本页面的计时器提示音是：自制手机铃声 许可:CC-BY 作者:scottchains 来源:耳聆网 https://www.ear0.com/sound/37361</p>
        <p>本页面的完成音效是：完成音效 许可:CC-BY-NC 作者:nckn 来源:耳聆网 https://www.ear0.com/sound/12432</p>
    </footer>
    <!-- 引入 NoSleep.js -->
    <script src="{{ url_for('static', filename='js/NoSleep.min.js') }}"></script>
    <script>
        // 初始化 NoSleep
        var noSleep = new NoSleep();
        console.log('NoSleep 已初始化');

        
        // 初始化参数
        const workTime = parseInt({{ time }}); 
        const restRatio = parseInt({{ rest_time_to_work_ratio }}); 
        const restTime = Math.round(workTime / restRatio); 
        const isRepeat = {{ repeat | lower }}; 

        let currentTime = workTime * 60; 
        let isWorking = true;
        let timerInterval;
        let heartbeatInterval; // 心跳保活定时器
        let audioContext; // 新增音频上下文变量

        // 新增：用户首次点击解锁自动播放和防止休眠
        function unlockAudio() {
            // 启用 NoSleep 防止设备休眠
            try{
            noSleep.enable();
            console.log('NoSleep 已启用');
            } catch (error) {
                console.error('NoSleep 启用失败：', error);
            }
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.resume().then(() => {
                console.log('音频上下文已解锁');
                document.querySelector('.audio-prompt').style.display = 'none'; // 隐藏提示
            });
            document.body.removeEventListener('click', unlockAudio);
        }
        document.body.addEventListener('click', unlockAudio); // 监听首次点击

        // 心跳保活函数
        function sendHeartbeat() {
            // 创建一个隐藏的iframe来发送心跳请求
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = '/heartbeat';
            document.body.appendChild(iframe);
            
            // 一段时间后移除iframe以释放资源
            setTimeout(() => {
                if (iframe.parentNode) {
                    iframe.parentNode.removeChild(iframe);
                }
            }, 5000); // 5秒后移除
        }

        // 启动心跳保活机制，每5分钟发送一次心跳
        function startHeartbeat() {
            // 立即发送一次心跳
            sendHeartbeat();
            // 每5分钟发送一次心跳
            heartbeatInterval = setInterval(sendHeartbeat, 5 * 60 * 1000);
        }

        // 停止心跳保活机制
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            // 禁用 NoSleep 允许设备休眠
            noSleep.disable();
            console.log('NoSleep 已禁用');
        }

        // 更新时间显示（保持不变）
        function updateDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            document.getElementById('time-display').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // 切换阶段
        function switchPhase() {
            isWorking = !isWorking;
            currentTime = isWorking ? workTime * 60 : restTime * 60;
            document.getElementById('status').textContent = isWorking ? '工作中' : '休息中';

            // 休息阶段开始时播放音频（使用已解锁的上下文）
            if (!isWorking && restTime > 0) {
                const audio = new Audio("/timer_sound");
                // 检查是否需要恢复上下文（兼容旧浏览器）
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => audio.play());
                } else {
                    audio.play().catch(error => {
                        console.error('音频播放失败:', error);
                    });
                }
            }
        }

        // 倒计时结束处理
        function handleFinish() {
            clearInterval(timerInterval);
            if (isWorking) {
                // 工作结束后切换到休息
                if (restTime > 0) {
                    switchPhase();
                    timerInterval = setInterval(() => {
                        currentTime--;
                        updateDisplay();
                        if (currentTime <= 0) handleFinish();
                    }, 1000);
                } else {
                    // 无休息时间直接提交
                    stopHeartbeat(); // 停止心跳
                    document.getElementById('timer-form').submit();
                }
            } else {
                // 休息结束，播放完成音效
                const finishAudio = new Audio("/finish_sound");
                finishAudio.play().then(() => {
                    // 音效播放完成后提交表单
                    stopHeartbeat(); // 停止心跳
                    document.getElementById('timer-form').submit();
                }).catch(error => {
                    console.error('完成音效播放失败:', error);
                    // 即使播放失败，仍然提交表单
                    stopHeartbeat(); // 停止心跳
                    document.getElementById('timer-form').submit();
                });
            }
        }

        // 启动计时器
        updateDisplay();
        startHeartbeat(); // 启动心跳保活
        timerInterval = setInterval(() => {
            currentTime--;
            updateDisplay();
            if (currentTime <= 0) handleFinish();
        }, 1000);
    </script>
</body>

</html>